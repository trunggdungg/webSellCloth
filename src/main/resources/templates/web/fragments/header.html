<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>

<!-- Header -->
<header class="header js-header">
    <!-- Container -->
    <div class="container container--type-2">
        <!-- Header container -->
        <div class="header__container d-flex align-items-center">
            <!-- Logo -->
            <h1 class="header__logo">
                <a href="/"> UTERO </a>
            </h1>
            <!-- End logo -->
            <!-- Navigation -->
            <ul class="header__nav">
                <li>
                    <a href="/" class="nav__item nav__item--current">Home</a>

                </li>
                <li>
                    <a href="/shop" class="nav__item">Shop</a>

                </li>
                <!--                    <li>-->
                <!--                        <a href="/product" class="nav__item ">Product</a>-->
                <!--                    </li>-->
            </ul>
            <!-- End navigation -->
            <!-- Header right -->
            <ul class="header__right">
                <li>
                    <a href="#" class="js-open-popup-search"
                    ><i class="lnil lnil-search-alt"></i
                    ></a>
                </li>

                <li class="header__cart user-menu">
                    <a href="#"><i class="lnil lnil-user"></i></a>
                    <!-- Header cart -->
                    <div class="header-cart">
                        <!-- Cart items -->
                        <ul class="header-cart__items">
                            <li class="cart-item d-flex" th:if="${session.CURRENT_USER == null}">
                                <p class="cart-item__details">
                                    <a href="/account" class="cart-item__title">Đăng nhập</a>
                                </p>
                            </li>
                            <li class="cart-item d-flex" th:if="${session.CURRENT_USER != null}">
                                <p class="cart-item__details">
                                    <a href="/profile" class="cart-item__title">Thông tin cá nhân</a>
                                </p>
                            </li>
                            <li class="cart-item d-flex" th:if="${session.CURRENT_USER != null}">
                                <p class="cart-item__details">
                                    <a onclick="logout()" style="cursor: pointer" class="cart-item__title">Đăng
                                        xuất</a>
                                </p>
                            </li>
                        </ul>
                        <!-- Subtotal -->
                        <div class="header-cart__subtotal d-flex" th:if="${session.CURRENT_USER != null}">
                            <div class="subtotal__title">Xin chào</div>
                            <div class="subtotal__value" th:text="${session.CURRENT_USER.fullName}">Trung Dũng</div>
                        </div>

                        <ul class="header-cart__items mt-2"
                            th:if="${session.CURRENT_USER != null && session.CURRENT_USER.userRole.toString() == 'ADMIN'}">
                            <li class="cart-item d-flex">
                                <p class="cart-item__details">
                                    <a href="/admin/product" class="cart-item__title">Quản lý</a>
                                </p>
                            </li>
                        </ul>
                    </div>
                </li>


                <li class="header__cart">
                    <a href="/cart"
                    ><i class="lnil lnil-cart"></i><span th:if="${session.CURRENT_USER != null}"
                                                         id="cart-count">0</span>
                        <p class="header-cart__price totalPrice" th:if="${session.CURRENT_USER != null}">$00</p>
                    </a
                    >
                    <!-- Header cart -->
                    <div class="header-cart">

                        <!-- Cart items -->
                        <ul class="header-cart__items">
                            <li class="cart-item d-flex" th:if="${session.CURRENT_USER == null}">
                                <p class="cart-item__details">
                                        <span class="cart-item__title"
                                              style="font-size: 20px; pointer-events: none;cursor: default;">Giỏ hàng trống!</span>
                                </p>
                            </li>
                            <!-- Item -->
                            <ul class="cart-container ">
                                <!-- Danh sách sản phẩm trong giỏ hàng sẽ được thêm vào đây bằng JavaScript -->
                            </ul>

                        </ul>
                        <!-- End cart items -->
                        <!-- Subtotal -->
                        <div class="header-cart__subtotal d-flex" th:if="${session.CURRENT_USER != null}">

                            <div class="subtotal__title">Subtotal</div>

                            <div class="subtotal__value totalPrice">$272.47</div>

                        </div>

                        <div class="header-cart__action" th:if="${session.CURRENT_USER != null}">
                            <a
                                    href="/checkout"
                                    class="header-cart__button header-cart__button--checkout"
                            >Checkout</a
                            >
                            <a href="/cart" class="header-cart__button"
                            >View cart</a
                            >
                        </div>
                        <!-- End Header cart action -->
                    </div>
                    <!-- End header cart -->
                </li>
                <li class="header__canvas-menu">
                    <a href="#" class="js-open-sidebar-contact"
                    ><i class="lnil lnil-menu"></i
                    ></a>
                </li>
            </ul>
            <!-- End header right -->
        </div>
        <!-- End header container -->
    </div>
    <!-- End container -->
</header>
<!-- End header -->

<!-- Sidebar contact -->
<div class="sidebar-contact js-sidebar-contact">
    <!-- Background -->
    <div class="sidebar-contact__background js-close-sidebar-contact"></div>
    <!-- End background -->
    <!-- Content -->
    <div class="sidebar-contact__content">
        <!-- Close -->
        <div class="sidebar-contact__close"><a href="#" class="js-close-sidebar-contact"><i class="lnil lnil-close"></i></a>
        </div>
        <!-- End close -->
        <!-- Section -->
        <div class="sidebar-contact__section">
            <!-- Title -->
            <h6 class="sidebar-contact-section__title">Contact</h6>
            <!-- End title -->
            <!-- Item -->
            <div class="sidebar-contact-section__item d-flex">
                <!-- Icon -->
                <div class="sidebar-contact-section-item__icon"><i class="lnil lnil-map-marker"></i></div>
                <!-- End icon -->
                <!-- Text -->
                <div class="sidebar-contact-section-item__text">
                    No. Rosecrans Ave, Suite 200 El Segundo, CA 90245. USA
                </div>
                <!-- End text -->
            </div>
            <!-- End item -->
            <!-- Item -->
            <div class="sidebar-contact-section__item d-flex">
                <!-- Icon -->
                <div class="sidebar-contact-section-item__icon">
                    <i class="lnil lnil-phone-ring"></i>
                </div>
                <!-- End icon -->
                <!-- Text -->
                <div class="sidebar-contact-section-item__text">
                    Call: +1 (202) 861-5567
                </div>
                <!-- End text -->
            </div>
            <!-- End item -->
            <!-- Item -->
            <div class="sidebar-contact-section__item d-flex">
                <!-- Icon -->
                <div class="sidebar-contact-section-item__icon"><i class="lnil lnil-message-edit"></i></div>
                <!-- End icon -->
                <!-- Text -->
                <div class="sidebar-contact-section-item__text">
                    Email: support@demo.com
                </div>
                <!-- End text -->
            </div>
            <!-- End item -->
        </div>
        <!-- End section -->
        <!-- Section -->
        <div class="sidebar-contact__section">
            <!-- Title -->
            <h6 class="sidebar-contact-section__title">Connect on Social</h6>
            <!-- End title -->
            <!-- Socials -->
            <ul class="sidebar-contact-section__socials">
                <li><a href="https://twitter.com/" target="_blank"><i class="lnil lnil-twitter"></i></a></li>
                <li><a href="https://facebook.com/" target="_blank"><i class="lnil lnil-facebook"></i></a></li>
                <li><a href="https://instagram.com/" target="_blank"><i class="lnil lnil-Instagram"></i></a></li>
            </ul>
            <!-- End socials -->
        </div>
        <!-- End section -->
    </div>
    <!-- End content -->
</div>
<!-- End sidebar contact -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"
        integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"
        integrity="sha512-VEd+nq25CkR676O+pLBnDW09R7VQX9Mdiij052gVCp5yVH3jGtH70Ho/UUv4mJDsEdTvqRCFZg0NKGiojGnUCw=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script th:src="@{/assets/js/main.js}"></script>
<script th:src="@{/assets/js/search-product.js}"></script>

<script th:inline="javascript">


    window.logout = () => {
        axios.post('/api/auth/logout').then(res => {
            if (res.status === 200) {
                toastr.success("Đăng xuất thành công");
                setTimeout(() => {
                    window.location.href = '/';
                }, 1500)
            }
        }).catch(err => {
            console.log(err);
            toastr.error("Đăng xuất thất bại");
        })
    }
</script>
<script>
    document.addEventListener("DOMContentLoaded", () => {
        // Gọi API để lấy dữ liệu giỏ hàng
        fetch("/api/cart/items")
            .then(response => {
                if (!response.ok) {
                    throw new Error("User not logged in or unable to fetch cart items.");
                }
                return response.json();
            })
            .then(cartItems => {
                // Hàm để render giỏ hàng ra giao diện
                renderCartItems(cartItems);

                // Hàm để tính toán tổng giỏ hàng
                calculateSubtotal(cartItems);

                // Đếm số lượng loại sản phẩm
                const itemCount = cartItems.length;
                console.log("Number of unique products in cart:", itemCount);

                // Đếm tổng số lượng sản phẩm
                const totalQuantity = cartItems.reduce((total, item) => total + item.quantity, 0);
                console.log("Total quantity of all items in cart:", totalQuantity);

                // Hiển thị số lượng trong giao diện
                const cartCountEl = document.getElementById("cart-count");
                if (cartCountEl) {
                    cartCountEl.innerText = itemCount; // Hiển thị tổng số lượng sản phẩm
                }
            })
            .catch(error => {
                console.error("Error fetching cart items:", error);
            });
    });


    function renderCartItems(cartItems) {
        const cartContainer = document.querySelector(".cart-container");
        console.log("cartItems", cartItems);
        cartItems.forEach(item => {

            const cartItemHTML = `
                <li class="cart-item d-flex">
                    <p class="cart-item__image">
                        <a href="product.html">
                            <img
                                alt="Image"
                                src="${item.productVariant.product.imageUrlPrimary}"
                                class="lazyload lazy-effect"
                            />
                        </a>
                    </p>
                    <p class="cart-item__details">
                        <a href="product.html" class="cart-item__title">${item.productVariant.product.name}</a>
                        <span class="cart-item__variant">${item.productVariant.color.nameColor}, ${item.productVariant.size.sizeName}</span>
                       <span class="cart-item__price">
                ${item.quantity} <i>x</i>${item.productVariant.product.discount != null
                ? (item.productVariant.product.price - (item.productVariant.product.price * item.productVariant.product.discount) / 100).toFixed(2)
                : item.productVariant.product.price.toFixed(2)}
                        </span>

                    </p>
                    <p class="cart-item__delete">
                        <a href="#"><i class="lnil lnil-close"></i></a>
                    </p>
                </li>
            `;
            // Thêm phần tử mới vào container
            cartContainer.innerHTML += cartItemHTML;
        });
    }

    // Hàm tính toán tổng giỏ hàng (subtotal)
    function calculateSubtotal(cartItems) {
        let totalPriceSub = 0; // Khởi tạo tổng giá trị của giỏ hàng

        cartItems.forEach(item => {
            totalPriceSub += item.price; // Cộng dồn giá trị của từng sản phẩm
        });
        // Hiển thị tổng giỏ hàng với 2 chữ số thập phân
        // Cập nhật nội dung của từng phần tử
        // Lấy tất cả các phần tử có lớp "totalPrice"
        const totalPriceElements = document.querySelectorAll(".totalPrice");
        totalPriceElements.forEach(el => {
            el.innerHTML = `$${totalPriceSub.toFixed(2)}`; // Định dạng giá trị với 2 chữ số thập phân
        });
    }

</script>
</body>
</html>